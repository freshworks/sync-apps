<html>
<head>
  <title>Installation</title>
  <link rel='stylesheet' type='text/css' href='https://static.freshdev.io/fdk/2.0/assets/freshteam.css'>
  <link rel="stylesheet" type="text/css" href="./assets/iparams.css">
  <style>
    .level-2 {
      padding-left: 3%;
    }
    .level-3 {
        padding-left: 6%;
    }
  </style>
</head>
<body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
<script src="https://static.freshdev.io/fdk/2.0/assets/fresh_client.js"></script>
<script type="module" src="https://unpkg.com/@freshworks/crayons/dist/crayons/crayons.esm.js"></script>
<script nomodule src="https://unpkg.com/@freshworks/crayons/dist/crayons/crayons.js"></script>
<script type= "text/javascript">

let isIntegrationCreated = false;
let freshteamApiKey = null;
let freshteamDomain = null;
let isFreshteamConnected = false;
let isFreshteamJobPostingCreated = false;
let isMonsterConnected = false;
let isMonsterJobPostingCreated = false;
let isTransformationCreated = false;
let isInitcallDone = false;
const logHeadingPadding = 70;
const logElementsPadding = 65;
const logElementStyle = "white-space: pre; font-family: Courier New;";

function getConfigs(configs) {
  //write your code here
  console.log('function called', configs);
};

function validate() {
  return true;
};

function postConfigs() {
  //write your code here
  var configs = {
      'isInstalled': true
  };
  return configs;
};

function showNotification(status, message) {
	client.interface.trigger("showNotify", {
		type: `${status}`,
		message: `${message}`
    });
}

function toggleLogs(fullDivId, collapsedDivId) {
    var currentClass = $($(`div#${fullDivId}`)[0]).prop('class');
    if (currentClass === 'level-3'){
        $($(`div#${fullDivId}`)[0]).prop('class', '')
        $($(`div#${fullDivId}`)[0]).prop('style', 'display:none')
        $($(`div#${collapsedDivId} fw-icon`)[0]).prop('name', 'chevron-right')
    } else {
        $($(`div#${fullDivId}`)[0]).prop('class', 'level-3')
        $($(`div#${fullDivId}`)[0]).prop('style', '')
        $($(`div#${collapsedDivId} fw-icon`)[0]).prop('name', 'chevron-down')
    }
}

function setButton(buttonId, text, isDisable) {
    var jq = 'fw-button#' + buttonId;
    $(jq).prop('disabled', isDisable);
    $(jq).html(text);
}

function updateCache(data){
    client.request.invoke('updateCache',{'data':data}).then(
        function(){
            console.log('iparams: updated the details in cache successfully.');
        },
        function(error){
            console.log('update of the details in cache failed.');
        }
    );
}

function connectFreshteam() {
    var domain = $('fw-input#domain').val()
    var apiKey = $('fw-input#api_key').val()
    var connectPayload = {
        'domain': domain,
        'api_key': apiKey
    }
    setButton('freshteamConnect', 'Connecting...', true)
    freshteamApiKey = apiKey;
    freshteamDomain = domain;

    updateCache({'freshteamDomain': domain, 'freshteamApiKey': apiKey});

    client.request.invoke("connectFreshteam", connectPayload).then(
        function(success) {
            isFreshteamConnected = true;
            var schemaPayload = {
                'domain': domain,
                'api_key': apiKey,
                'is_created': isFreshteamJobPostingCreated
            }
            client.request.invoke("createJobPostingSchema", connectPayload).then(
                function(success) {
                    isFreshteamJobPostingCreated = true;
                    updateCache({'isFreshteamJobPostingCreated': isFreshteamJobPostingCreated});
                    setButton('freshteamConnect', 'Connect', false)
                },
                function(error) {
                    setButton('freshteamConnect', 'Connect', false)
                }
            )
            // showNotification('success', 'Connect successful');
        },
        function(error){
            setButton('freshteamConnect', 'Connect', false)
            // showNotification('danger', 'Unable to connect');
        }
    )
}

function connectMonster() {
    setButton('monsterConnect', 'Connecting...', true)
    var domain = $('fw-input#monster_domain').val()
    var username = $('fw-input#monster_username').val()
    var password = $('fw-input#monster_password').val()
    var connectPayload = {
        'domain': domain,
        'username': username,
        'password': password
    }
    updateCache({'monsterDomain': domain, 'monsterUsername': username, 'monsterPassword': password});
    client.request.invoke("connectMonster", connectPayload).then(
        function(success) {
            isMonsterConnected = true;
            client.request.invoke("createMonsterJobPostingSchema", {}).then(
                function(success) {
                    isMonsterJobPostingCreated = true;
                    client.request.invoke('createMapping', {}).then(
                        function(){
                            isTransformationCreated = true;
                            updateCache({'isTransformationCreated': isTransformationCreated});
                            setButton('monsterConnect', 'Connect', false)
                        },
                        function(error){
                            setButton('monsterConnect', 'Connect', false)
                        }
                    )
                },
                function(error) {
                    setButton('monsterConnect', 'Connect', false)
                }
            )
            // showNotification('success', 'Connect successful');
        },
        function(error){
            setButton('monsterConnect', 'Connect', false)
            // showNotification('danger', 'Unable to connect');
        }
    )
}

$(document).ready(function () {
	app.initialized()
		.then(function (_client) {
            window.client = _client;
			//Registers componenet event, All custom events for the components has to be regisered like below
            document.getElementById("freshteamConnect").addEventListener("fwClick", connectFreshteam);
            document.getElementById("monsterConnect").addEventListener("fwClick", connectMonster);
            document.getElementById('refreshLogs').addEventListener("fwClick", reloadLogs);
            console.log('app initialising')
            client.iparams.get().then(
                function(iparams){
                    console.log(iparams)
                    if(iparams.isInstalled){
                        $('div#integrationCreateDiv').attr('style', 'display:none')
                        $('div#tabsDiv').attr('style', '')
                        client.request.invoke('getCache',{}).then(
                            function(data){
                                var configs = data.response;
                                $('fw-input#domain').val(configs.freshteamDomain)
                                $('fw-input#api_key').val(configs.freshteamApiKey)
                                $('fw-input#monster_domain').val(configs.monsterDomain)
                                $('fw-input#monster_username').val(configs.monsterUsername)
                                $('fw-input#monster_password').val(configs.monsterPassword)
                            },
                            function(error){
                                console.log('Error while fetching the configs.', error);
                            }
                        )
                    }
                },
                function(error){
                    console.log('Error while fetching the iparams');
                }
            )
		})
		.catch(function (error) {
			console.log('danger', 'Sorry! Unable to load app');
		});
});

async function fetchSyncLogs() {
    var logs = await client.request.invoke('getSyncStatus', {})
    logs = logs.response;
    var html = ''
    var key = 'logs';
    var syncStatusLogs = logs;
    var fullId = '_full';
    var collapsedId = key + '_collapsed';
    var logText = `     Click here to view sync status.     `;
    html += `<div id=${collapsedId} class='level-2' onclick="toggleLogs('${fullId}','${collapsedId}')"><br/><fw-icon color="green" name="chevron-right"></fw-icon> <fw-label style="${logElementStyle}" color="green" value="${logText.padEnd(logHeadingPadding, ' ')}"></fw-label></div><br/><div class="" id=${fullId} style="display: none">`
    if (syncStatusLogs.length == 0){
        html += '<fw-label color="blue" value="No logs to display"></fw-label></div>'
    }
    for (var index in syncStatusLogs){
        var syncLog = syncStatusLogs[index];
        var updatedAt = new Date(syncLog.updatedAt);
        var timestamp = updatedAt.toLocaleString("en-GB", {
            day: "numeric",
            month: "short",
            year: "numeric",
            hour: "numeric",
            minute: "2-digit",
            second: "2-digit"
            });
        if ( syncLog.status === 'INPROGRESS' ) {
            syncLog.status = 'DONE';
        }
        var idealElementLength = 30; // used for padding extra white spaces to the elements in the sync run history logs
        var str = `     Synched At: ${timestamp.padEnd(idealElementLength, ' ')} |     ID: ${syncLog.objectId.padEnd(idealElementLength, ' ')}  |     Status: ${syncLog.status.padEnd(10, ' ')}`
        html += `<fw-label color="blue" style="${logElementStyle}" value="${str}"></fw-label><br/><br/>`;
    }
    html += '</div>'
    
    return html;
}

function setLoadingForTab(fwTabDivId, msg='Please wait while the mappings are loading...'){
    var loadingHtml = `<div style="padding-left: 11%;padding-top: 7%;"><fw-spinner style="display: inline-block;" size="medium" color="green" class="hydrated"></fw-spinner><label style="display: inline-block;padding-left: 1%;font-size: 14px;">${msg}</label></div>`
    $('#' + fwTabDivId).html(loadingHtml);
} 

async function reloadLogs(){
    setLoadingForTab('logs', 'Please wait while logs are being loaded');
    var html = await fetchSyncLogs();
    $('#' + 'logs').html(html);
}

</script>
<div id="integrationCreateDiv">
    <fw-label value="Click on the install button to start using the app"></fw-label>
</div>

<div id="failedDiv" style="display:none">
    <fw-spinner size="large" color="green"></fw-spinner>
    <fw-label value="Failed to create integration. Please contact support."></fw-label>
</div>

<div id="tabsDiv" style="display:none">
<fw-tabs>
    <fw-tab tab-header="Freshteam">
        <fw-input
            id="domain"
            label="Domain"
            icon-left="browser"
            state-text="Enter the domain with https://"
            state="warning"
            placeholder="Enter your freshteam domain"
            required
            clear-input>
        </fw-input>
        <fw-input
            id="api_key"
            label="API Key"
            icon-left="password"
            placeholder="Enter your freshteam API key"
            required
            clear-input>
        </fw-input>
        <fw-button color="primary" id="freshteamConnect">Connect</fw-button>
    </fw-tab>
    <fw-tab tab-header="Monster">
        <fw-input
            id="monster_domain"
            label="Domain"
            icon-left="browser"
            placeholder="Enter your Monster domain"
            required
            clear-input>
        </fw-input>
        <fw-input
            id="monster_username"
            label="Username"
            icon-left="password"
            placeholder="Enter your monster username"
            required
            clear-input>
        </fw-input>
        <fw-input
        id="monster_password"
        label="Password"
        icon-left="password"
        placeholder="Enter your monster password"
        required
        clear-input>
    </fw-input>
        <fw-button id="monsterConnect">Connect</fw-button>
    </fw-tab>
    <fw-tab tab-header="Sync">
        <fw-button size="small" style="padding-right:2%; float: right;" id="refreshLogs">Refresh logs</fw-button>
        <br/><br/>
        <div id="logs"></div>
    </fw-tab>
  </fw-tabs>
</div>
</body>
</html>